{% extends "base.html" %}

{% block title %}Dashboard | MahilMart License Manager{% endblock %}
{% block body_class %}page-dashboard{% endblock %}

{% block header_icon %}<i class="fas fa-key"></i>{% endblock %}
{% block header_title %}MahilMart License Key Generator{% endblock %}
{% block header_actions %}
  <span class="app-chip"><i class="fas fa-user"></i>User: {{ request.user.username }}</span>
  <a href="{% url 'licenses:expired_keys' %}" class="app-btn">
    <i class="fas fa-hourglass-end"></i>Expired Keys ({{ expired_keys_count }})
  </a>
  {% if request.user.is_superuser %}
    <a href="{% url 'licenses:user_list' %}" class="app-btn"><i class="fas fa-users"></i>Users</a>
  {% endif %}
  <form method="post" action="{% url 'licenses:logout' %}" class="header-inline-form">
    {% csrf_token %}
    <button type="submit" class="app-btn"><i class="fas fa-right-from-bracket"></i>Logout</button>
  </form>
{% endblock %}

{% block content %}
  <section class="panel dashboard-intro">
    <h1>License Dashboard</h1>
    <p>Generate keys, monitor usage, and manage runtime MongoDB settings.</p>
  </section>

  <div class="dashboard-stats">
    <div class="dashboard-stat">
      <div class="dashboard-stat-label">Total Keys</div>
      <div class="dashboard-stat-value">{{ total_keys }}</div>
    </div>
    <div class="dashboard-stat">
      <div class="dashboard-stat-label">Today Keys</div>
      <div class="dashboard-stat-value">{{ today_keys }}</div>
    </div>
    <div class="dashboard-stat">
      <div class="dashboard-stat-label">Unique Machines</div>
      <div class="dashboard-stat-value">{{ unique_machines }}</div>
    </div>
    <div class="dashboard-stat">
      <div class="dashboard-stat-label">Last Generated</div>
      <div class="dashboard-stat-value dashboard-last-value">
        {% if last_generated %}{{ last_generated|date:"Y-m-d H:i:s" }}{% else %}-{% endif %}
      </div>
    </div>
  </div>

  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="msg {% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="dashboard-split">
    <section class="panel">
      <h2 class="dashboard-panel-title">Generate License</h2>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_action" value="generate_license">
        <div class="dashboard-form-grid">
          <div class="dashboard-field">
            <label>Machine ID</label>
            <input type="text" name="machine_id" value="{{ form_values.machine_id }}" placeholder="DESKTOP-XXXXXXX" required>
          </div>
          <div class="dashboard-field">
            <label>Contact Email</label>
            <input type="email" name="contact_email" value="{{ form_values.contact_email }}" placeholder="customer@email.com">
          </div>
          <div class="dashboard-field">
            <label>Customer Name</label>
            <input type="text" name="customer_name" value="{{ form_values.customer_name }}" placeholder="Customer name">
          </div>
          <div class="dashboard-field">
            <label>License Email (Fixed)</label>
            <input type="text" value="{{ license_email|default:'mahiltechlab.ops@gmail.com' }}" readonly>
          </div>
          <div class="dashboard-field dashboard-full">
            <label>Note</label>
            <textarea name="note" placeholder="Optional notes">{{ form_values.note }}</textarea>
          </div>
        </div>
        <div class="dashboard-form-row">
          <button class="dash-btn dash-btn-main" type="submit">Generate Key</button>
          <button class="dash-btn dash-btn-lite" type="button" id="copyBtn" {% if not generated_key %}disabled{% endif %}>Copy Key</button>
        </div>
      </form>

      <div class="dashboard-output">
        <div class="dashboard-machine">Generated for: <strong>{{ generated_machine|default:"-" }}</strong></div>
        <div class="dashboard-license" id="generatedKeyText">{% if generated_key %}{{ generated_key }}{% else %}No key generated yet{% endif %}</div>
      </div>
    </section>

    <section class="panel">
      <h2 class="dashboard-panel-title">Recent Active Keys</h2>
      <div class="table-wrap">
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>License Key</th>
              <th>Machine</th>
              <th>Customer</th>
              <th>Contact Email</th>
              <th>Note</th>
              <th>Valid Until</th>
              <th>Status</th>
              <th>Source</th>
              <th>At</th>
              <th>By</th>
            </tr>
          </thead>
          <tbody>
            {% for item in recent_licenses %}
              <tr>
                <td>{{ item.license_key }}</td>
                <td>{{ item.machine_id }}</td>
                <td>{{ item.customer_name|default:"-" }}</td>
                <td>{{ item.contact_email|default:"-" }}</td>
                <td>{{ item.note|default:"-" }}</td>
                <td>{% if item.valid_until %}{{ item.valid_until|date:"Y-m-d H:i:s" }}{% else %}-{% endif %}</td>
                <td>{{ item.status|default:"-" }}</td>
                <td>{{ item.source|default:"-" }}</td>
                <td>{{ item.generated_at|date:"Y-m-d H:i:s" }}</td>
                <td>{{ item.generated_by|default:"-" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="10">No active keys right now.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>

  {% if request.user.is_superuser %}
    <section class="panel dashboard-mongo">
      <h2 class="dashboard-panel-title">MongoDB Settings</h2>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_action" value="save_mongo_settings">
        <div class="dashboard-form-grid">
          <div class="dashboard-field dashboard-full">
            <label>Mongo URI</label>
            <input type="text" name="mongo_uri" value="{{ mongo_form_values.mongo_uri }}" placeholder="mongodb+srv://...">
          </div>
          <div class="dashboard-field">
            <label>Mongo DB</label>
            <input type="text" name="mongo_db" value="{{ mongo_form_values.mongo_db }}" required>
          </div>
          <div class="dashboard-field">
            <label>Mongo Collection</label>
            <input type="text" name="mongo_collection" value="{{ mongo_form_values.mongo_collection }}" required>
          </div>
        </div>
        <div class="dashboard-form-row">
          <button class="dash-btn dash-btn-main" type="submit">Save Mongo Settings</button>
        </div>
      </form>
    </section>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script>
    (function () {
      const copyButton = document.getElementById("copyBtn");
      const keyTextNode = document.getElementById("generatedKeyText");
      if (!copyButton || !keyTextNode) return;
      const defaultLabel = copyButton.textContent;

      function legacyCopy(text) {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "readonly");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        let ok = false;
        try {
          ok = !!document.execCommand("copy");
        } catch (e) {
          ok = false;
        }
        document.body.removeChild(ta);
        return ok;
      }

      copyButton.addEventListener("click", async function () {
        const text = (keyTextNode.textContent || "").trim();
        if (!text || text === "No key generated yet") return;
        let copied = legacyCopy(text);
        if (!copied && navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
          try {
            await navigator.clipboard.writeText(text);
            copied = true;
          } catch (e) {
            copied = false;
          }
        }
        copyButton.textContent = copied ? "Copied" : "Copy Manually";
        if (!copied && window.prompt) {
          window.prompt("Copy manually (Ctrl+C then Enter):", text);
        }
        setTimeout(function () {
          copyButton.textContent = defaultLabel;
        }, 1400);
      });
    })();
  </script>
{% endblock %}
